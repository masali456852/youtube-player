<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Super Player â€” Ù…Ø¨Ø§Ø´Ø± + HLS + DASH + YouTube/Vimeo/TikTok/Facebook</title>

  <style>
    :root{
      --bg:#0b1020; --text:#ffffff; --muted:#a9b3d6; --card:#121a33;
      --accent:#5b8cff; --danger:#ff5b6a; --ok:#36d399;
      --border:rgba(255,255,255,.14); --border2:rgba(255,255,255,.2);
      --pill:#1c2a5f; --chip:#0c1535;
    }
    body.light{
      --bg:#f6f7fb; --text:#0a1024; --muted:#44506e; --card:#ffffff;
      --accent:#3b6cff; --danger:#d12e45; --ok:#1db980;
      --border:rgba(0,0,0,.12); --border2:rgba(0,0,0,.18);
      --pill:#e9efff; --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:20px; background:var(--bg); color:var(--text);
      font-family:Tahoma,Arial,sans-serif;
    }
    h3{margin:0 0 10px}
    .container{max-width:1200px;margin:auto}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input{
      flex:1 1 600px; padding:12px; border-radius:10px; border:1px solid var(--border2);
      background:rgba(0,0,0,.05); color:var(--text); outline:none; direction:ltr
    }
    button{
      padding:11px 14px; border-radius:10px; border:1px solid var(--border2);
      background:var(--accent); color:#fff; font-weight:700; cursor:pointer
    }
    .btn-ghost{background:transparent; color:var(--text)}
    .btn-danger{background:var(--danger); border-color:transparent}
    .btn-ok{background:var(--ok); border-color:transparent}
    .box{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px}
    .msg{margin-top:8px; color:var(--muted); font-size:13px; line-height:1.8; white-space:pre-wrap}
    .err{color:var(--danger)}
    .grid{
      display:grid; grid-template-columns:2fr 1fr; gap:14px; margin-top:16px
    }
    @media(max-width:992px){ .grid{grid-template-columns:1fr} }
    .player-card{padding:0}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-bottom:1px solid var(--border);
      background:linear-gradient(0deg, transparent, rgba(0,0,0,.06))
    }
    .source{display:flex;align-items:center;gap:10px;min-width:0}
    .badge{padding:3px 10px; border-radius:999px; font-size:12px; color:#dbe2ff;
           border:1px solid var(--border2); background:var(--pill)}
    .urltxt{font-size:12px; color:#cfd6ff; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:48vw; direction:ltr}
    body.light .badge{color:#223; background:var(--pill)}
    body.light .urltxt{color:#334}
    .bar-btns{display:flex;gap:8px;flex-wrap:wrap}
    .ratio{position:relative; padding-top:56.25%} /* 16:9 */
    video, iframe, #ytWrap{position:absolute; inset:0; width:100%; height:100%; border:0; background:#000}
    #ytWrap{display:none}
    #embedFrame{display:none}
    video{display:none; background:#000}

    .section-title{margin:8px 0 6px; font-size:14px; color:#cfd6ff}
    body.light .section-title{color:#233}
    .dl-list{display:flex; flex-direction:column; gap:8px}
    .dl-item{padding:10px; background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:8px;
             display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap}
    .dl-left{display:flex; align-items:center; gap:10px}
    .meta{font-size:13px; color:#cfd6ff; direction:ltr}
    body.light .meta{color:#223}
    .row-btns{display:flex; gap:8px; flex-wrap:wrap}
    a.dl-btn,button.dl-btn,select.dl-btn{
      color:#fff; background:var(--accent); padding:8px 12px; border-radius:6px; text-decoration:none; font-weight:bold; border:0; cursor:pointer
    }
    select.dl-btn{appearance:none}
    .hidden{display:none!important}
    code{background:var(--chip); border:1px solid var(--border2); padding:2px 6px; border-radius:6px; color:inherit}

    .stat{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .stat .k{font-size:12px; color:var(--muted)}
    .stat .v{font-weight:bold}

    .history-list{display:flex; flex-direction:column; gap:8px; max-height:360px; overflow:auto}
    .history-item{display:flex; gap:8px; align-items:center; justify-content:space-between; border:1px solid var(--border); border-radius:8px; padding:8px}
    .history-url{direction:ltr; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:60%}
    .pill{display:inline-flex; align-items:center; gap:8px; background:var(--chip); border:1px solid var(--border2); color:#cfd6ff; padding:6px 10px; border-radius:999px; font-size:12px}
    body.light .pill{color:#223}
  </style>

  <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ -->
  https://cdn.jsdelivr.net/npm/hls.js@latest</script>
  <script src="https://cdn.jsdelivr.net/npm/dashjsdash.all.min.js</script>
  <script src="https://www.youtube.com/iframe_apiead>

<body>
  <div class="container">
    <div class="box">
      <div class="row">
        <input id="url" type="text"
          placeholder="mp4 / webm / m3u8 / mpd Ø£Ùˆ Ø±ÙˆØ§Ø¨Ø· YouTube / Vimeo / TikTok / Facebook (watch/embed/shorts/video)">
        <div class="row" style="gap:8px">
          <button id="playBtn">ØªØ´ØºÙŠÙ„</button>
          <button id="themeBtn" class="btn-ghost" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">ğŸŒ™/â˜€ï¸</button>
        </div>
      </div>
      <div id="msg" class="msg">
        â€¢ **Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ù…ØªØ§Ø­ ÙÙ‚Ø·** Ù„Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© (MP4/WEBM/M3U8/MPD Ø­ÙŠØ« ÙŠØ³Ù…Ø­ Ø§Ù„Ù…ØµØ¯Ø±).<br>
        â€¢ YouTube/Vimeo/TikTok/Facebook Ù„Ù„ØªØ´ØºÙŠÙ„ Ø¯Ø§Ø®Ù„ iframe ÙÙ‚Ø·ØŒ Ø§Ø­ØªØ±Ø§Ù…Ù‹Ø§ Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©.
      </div>
    </div>

    <div class="grid">
      <!-- Ø§Ù„Ù…Ø´ØºÙ‘Ù„ Ø§Ù„ÙƒØ¨ÙŠØ± -->
      <div class="box player-card" id="playerCard">
        <div class="topbar">
          <div class="source">
            <span id="srcBadge" class="badge">â€”</span>
            <span id="srcUrl" class="urltxt"></span>
          </div>
          <div class="bar-btns">
            <button id="copyBtn">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
            #<button>ÙØªØ­</button></a>
          </div>
        </div>
        <div class="ratio">
          <div id="ytWrap"><div id="ytPlayer"></div></div>
          <iframe id="embedFrame" allow="autoplay; encrypted-media; picture-in-picture; clipboard-write; web-share" allowfullscreen></iframe>
          <video id="video" controls playsinline crossorigin="anonymous"></video>
        </div>
      </div>

      <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª + ØªØ§Ø±ÙŠØ® -->
      <div class="box">
        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</h3>
        <div class="stat" style="margin-top:8px">
          <div><div class="k">Ø§Ù„Ø·ÙˆÙ„</div><div id="infoDuration" class="v">â€”</div></div>
          <div><div class="k">Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</div><div id="infoSize" class="v">â€”</div></div>
          <div><div class="k">Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù</div><div id="infoBytes" class="v">â€”</div></div>
          <div><div class="k">Ø§Ù„Ù…ØµØ¯Ø±</div><div id="infoSource" class="v">â€”</div></div>
        </div>

        <div style="margin-top:12px" class="row">
          <button id="btnShot" class="btn-ok">ğŸ“¸ Ù„Ù‚Ø·Ø© Ø´Ø§Ø´Ø©</button>
          <button id="btnThumb" class="btn-ok">ğŸ“· Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
          <button id="btnClear" class="btn-ghost">ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø´ØºÙ‘Ù„</button>
        </div>

        <div class="note" style="margin-top:10px">
          <span class="pill">ØªÙ„Ù…ÙŠØ­</span> Ù„Ù‚Ø·Ø© Ø§Ù„Ø´Ø§Ø´Ø© ØªØ¹Ù…Ù„ ÙÙ‚Ø· Ù…Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¯Ø§Ø®Ù„ &lt;video&gt; (MP4/WEBM/HLS/DASH)ØŒ ÙˆÙ„ÙŠØ³ Ù…Ø¹ Ù…Ø´ØºÙ„Ø§Øª iframe.
        </div>

        <hr style="opacity:.15; margin:16px 0">

        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Ø¢Ø®Ø± Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</h3>
          <div class="row" style="gap:8px">
            <button id="btnLoadSamples" class="btn-ghost">Ø£Ù…Ø«Ù„Ø©</button>
            <button id="btnClearHistory" class="btn-danger">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
          </div>
        </div>
        <div id="history" class="history-list" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¬ÙˆØ¯Ø§Øª -->
    <div id="panels" class="row" style="margin-top:14px">
      <div id="dlBox" class="box hidden" style="flex:1 1 520px">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h3 style="margin:0">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„</h3>
          <small class="msg">Ù‚Ø¯ ÙŠÙØ´Ù„ Ø¨Ø³Ø¨Ø¨ CORS Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±.</small>
        </div>
        <div class="section-title">Ø±ÙˆØ§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±Ø©</div>
        <div class="dl-list" id="dlList"></div>
      </div>

      <div id="hlsBox" class="box hidden" style="flex:1 1 320px">
        <h3 style="margin:0">Ø¬ÙˆØ¯Ø§Øª HLS (m3u8)</h3>
        <div class="dl-list" id="hlsList" style="margin-top:10px"></div>
        <div class="msg">Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† m3u8 (Ø¥Ù† Ø³Ù…Ø­ Ø§Ù„Ù…ØµØ¯Ø±): <code>ffmpeg -i "URL.m3u8" -c copy out.mp4</code></div>
      </div>

      <div id="dashBox" class="box hidden" style="flex:1 1 320px">
        <h3 style="margin:0">Ø¬ÙˆØ¯Ø§Øª DASH (mpd)</h3>
        <div class="row" style="gap:8px; margin-top:10px">
          <select id="dashQuality" class="dl-btn" style="min-width:180px">
            <option value="auto">ØªÙ„Ù‚Ø§Ø¦ÙŠ</option>
          </select>
          <button id="dashApply" class="dl-btn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¬ÙˆØ¯Ø©</button>
        </div>
        <div class="msg">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø¬ÙˆØ¯Ø© Ù…Ø­Ø¯Ø¯Ø©.</div>
      </div>
    </div>

  </div>

<script>
(function(){
  // Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø©
  const input = document.getElementById('url');
  const playBtn = document.getElementById('playBtn');
  const msg = document.getElementById('msg');
  const themeBtn = document.getElementById('themeBtn');

  const srcBadge = document.getElementById('srcBadge');
  const srcUrlTxt = document.getElementById('srcUrl');
  const copyBtn = document.getElementById('copyBtn');
  const openBtn = document.getElementById('openBtn');

  const video = document.getElementById('video');
  const ytWrap = document.getElementById('ytWrap');
  const embedFrame = document.getElementById('embedFrame');
  const playerCard = document.getElementById('playerCard');

  const infoDuration = document.getElementById('infoDuration');
  const infoSize = document.getElementById('infoSize');
  const infoBytes = document.getElementById('infoBytes');
  const infoSource = document.getElementById('infoSource');

  const btnShot = document.getElementById('btnShot');
  const btnThumb = document.getElementById('btnThumb');
  const btnClear = document.getElementById('btnClear');

  const dlBox = document.getElementById('dlBox');
  const dlList = document.getElementById('dlList');
  const hlsBox = document.getElementById('hlsBox');
  const hlsList = document.getElementById('hlsList');
  const dashBox = document.getElementById('dashBox');
  const dashQuality = document.getElementById('dashQuality');
  const dashApply = document.getElementById('dashApply');

  const historyWrap = document.getElementById('history');
  const btnClearHistory = document.getElementById('btnClearHistory');
  const btnLoadSamples = document.getElementById('btnLoadSamples');

  // Ø­Ø§Ù„Ø§Øª
  let currentHls = null;
  let dashPlayer = null;
  let ytApiReady = false;
  let ytPlayer = null;
  let pendingYtId = null;
  let currentKind = null; // 'direct'|'hls'|'dash'|'youtube'|'vimeo'|'tiktok'|'facebook'

  // YouTube API readiness
  window.onYouTubeIframeAPIReady = function(){ ytApiReady = true; if(pendingYtId){ createOrLoadYt(pendingYtId); pendingYtId=null; } };

  // =========== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===========
  const isHttpsPage = location.protocol === 'https:';
  const toHttps = (u)=> u.replace(/^http:\/\//i,'https://');
  const cleanUrl = (u)=> (u||'').trim().replace(/\s+/g,'').replace(/\?+$/,'');
  function validateUrl(u){ try{ new URL(u, location.href); return true; }catch{ return false; } }
  function absUrl(u){ try{ return new URL(u, location.href).toString(); }catch{ return u; } }
  function host(u){ try{ return new URL(u).hostname; }catch{ return ''; } }

  const isHls   = (u)=> /\.m3u8(\?|#|$)/i.test(u);
  const isDash  = (u)=> /\.mpd(\?|#|$)/i.test(u);
  const isFile  = (u)=> /\.(mp4|webm|m4v)(\?|#|$)/i.test(u);

  const isYouTube = (u)=> /(^|\.)youtube\.com$/i.test(host(u)) || /(^|\.)youtu\.be$/i.test(host(u));
  const isVimeo   = (u)=> /(^|\.)vimeo\.com$/i.test(host(u)) || /(^|\.)player\.vimeo\.com$/i.test(host(u));
  const isTikTok  = (u)=> /(^|\.)tiktok\.com$/i.test(host(u)) || /(^|\.)vm\.tiktok\.com$/i.test(host(u));
  const isFB      = (u)=> /(^|\.)facebook\.com$/i.test(host(u)) || /(^|\.)fb\.watch$/i.test(host(u));

  function showError(t){ msg.innerHTML = 'âŒ <span class="err">'+t+'</span>'; }
  function showInfo(t){ msg.innerHTML = 'â„¹ï¸ '+t; }

  function setTopBar(kind, url){
    const map = {direct:'Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±', hls:'HLS (m3u8)', dash:'DASH (mpd)', youtube:'YouTube', vimeo:'Vimeo', tiktok:'TikTok', facebook:'Facebook'};
    currentKind = kind;
    srcBadge.textContent = map[kind] || 'â€”';
    srcUrlTxt.textContent = url;
    openBtn.href = url;
    copyBtn.onclick = async ()=>{ try{ await navigator.clipboard.writeText(url); copyBtn.textContent='ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“'; setTimeout(()=>copyBtn.textContent='Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·',1200);}catch{ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø®'); } };
    infoSource.textContent = map[kind] || 'â€”';
  }

  function resetPanels(){
    // ØªÙˆÙ‚Ù HLS/DASH/YT
    if(currentHls){ try{ currentHls.destroy(); }catch{} currentHls=null; }
    if(dashPlayer){ try{ dashPlayer.reset(); }catch{} dashPlayer=null; }
    if(ytPlayer && ytPlayer.stopVideo){ try{ ytPlayer.stopVideo(); }catch{} }

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    video.style.display = 'none';
    video.pause(); video.removeAttribute('src'); while(video.firstChild) video.removeChild(video.firstChild); video.load();
    ytWrap.style.display = 'none';
    embedFrame.style.display = 'none'; embedFrame.removeAttribute('src');

    // ØµÙ†Ø§Ø¯ÙŠÙ‚
    dlBox.classList.add('hidden');
    hlsBox.classList.add('hidden');
    dashBox.classList.add('hidden');
    dlList.innerHTML = '';
    hlsList.innerHTML = '';
    dashQuality.innerHTML = '<option value="auto">ØªÙ„Ù‚Ø§Ø¦ÙŠ</option>';

    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
    infoDuration.textContent = 'â€”';
    infoSize.textContent = 'â€”';
    infoBytes.textContent = 'â€”';
  }

  // =========== Ø§Ù„Ø³Ø¬Ù„ (History) ===========
  const LS_KEY = 'super_player_history_v1';
  function loadHistory(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
  function saveHistory(it){
    const list = loadHistory().filter(x=>x.url!==it.url);
    list.unshift({...it, at: Date.now()});
    while(list.length>10) list.pop();
    localStorage.setItem(LS_KEY, JSON.stringify(list));
    renderHistory();
  }
  function renderHistory(){
    const list = loadHistory();
    historyWrap.innerHTML = '';
    if(!list.length){ historyWrap.innerHTML = '<div class="msg">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¨Ø¹Ø¯.</div>'; return; }
    list.forEach(rec=>{
      const row = document.createElement('div'); row.className='history-item';
      const left = document.createElement('div');
      const t = new Date(rec.at);
      left.innerHTML = `<div class="history-url">${rec.url}</div><div class="msg">${t.toLocaleString()}</div>`;
      const btn = document.createElement('button'); btn.textContent='ØªØ´ØºÙŠÙ„'; btn.onclick=()=>{ input.value = rec.url; playBtn.click(); };
      row.appendChild(left); row.appendChild(btn);
      historyWrap.appendChild(row);
    });
  }
  btnClearHistory.onclick = ()=>{ localStorage.removeItem(LS_KEY); renderHistory(); showInfo('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„.'); };
  btnLoadSamples.onclick = ()=>{
    input.value = 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8'; // Ù…Ø«Ø§Ù„ HLS
    playBtn.click();
    setTimeout(()=>{ input.value='https://dash.akamaized.net/envivio/EnvivioDash3/manifest.mpd'; }, 2000);
  };
  renderHistory();

  // =========== Ø§Ù„Ø«ÙŠÙ… ===========
  const THEME_KEY = 'super_player_theme';
  function applyTheme(v){ document.body.classList.toggle('light', v==='light'); localStorage.setItem(THEME_KEY, v); }
  applyTheme(localStorage.getItem(THEME_KEY)||'dark');
  themeBtn.onclick = ()=>{ applyTheme(document.body.classList.contains('light') ? 'dark' : 'light'); };

  // =========== Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ + Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ===========
  function formatTime(sec){ if(!isFinite(sec)) return 'â€”'; const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=Math.floor(sec%60); return (h?String(h).padStart(2,'0')+':':'')+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
  function formatBytes(b){ if(!b || !isFinite(b)) return 'â€”'; const u=['B','KB','MB','GB','TB']; let i=0; while(b>=1024 && i<u.length-1){ b/=1024; i++; } return b.toFixed(2)+' '+u[i]; }
  async function fetchHeadSize(url){
    try{
      const r = await fetch(url, { method:'HEAD', mode:'cors' });
      const len = r.headers.get('content-length');
      return len ? Number(len) : null;
    }catch{ return null; }
  }
  function attachVideoInfoHandlers(){
    video.onloadedmetadata = ()=>{
      infoDuration.textContent = formatTime(video.duration);
      infoSize.textContent = `${video.videoWidth || 'â€”'}Ã—${video.videoHeight || 'â€”'}`;
    };
  }
  attachVideoInfoHandlers();

  // =========== Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØµÙˆØ± ===========
  function captureFrame(){
    if(video.style.display==='none'){ alert('Ø§Ù„Ù…ÙŠØ²Ø© Ù…ØªØ§Ø­Ø© ÙÙ‚Ø· Ù…Ø¹ Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.'); return; }
    const w = video.videoWidth, h = video.videoHeight;
    if(!w || !h){ alert('Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø¨Ø¹Ø¯.'); return; }
    const cv = document.createElement('canvas'); cv.width=w; cv.height=h;
    const ctx = cv.getContext('2d'); ctx.drawImage(video, 0, 0, w, h);
    const url = cv.toDataURL('image/png');
    const a = document.createElement('a'); a.href=url; a.download='screenshot.png'; a.click();
  }
  btnShot.onclick = captureFrame;
  btnThumb.onclick = captureFrame; // Ù†Ù„ØªÙ‚Ø· Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒØµÙˆØ±Ø© Ù…ØµØºÙ‘Ø±Ø©

  btnClear.onclick = ()=>{ resetPanels(); srcBadge.textContent='â€”'; srcUrlTxt.textContent=''; showInfo('ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø´ØºÙ‘Ù„.'); };

  // =========== YouTube ===========
  function extractYtId(u){
    try{
      const url = new URL(u, location.href);
      if(url.hostname.endsWith('youtu.be')) return url.pathname.replace('/','').split(/[?&#]/)[0];
      if(url.pathname.startsWith('/embed/')) return url.pathname.split('/embed/')[1].split(/[?&#]/)[0];
      if(url.pathname.startsWith('/shorts/')) return url.pathname.split('/shorts/')[1].split(/[?&#]/)[0];
      const v = url.searchParams.get('v'); if(v) return v;
    }catch{}
    const m = String(u).match(/(?:v=|\/embed\/|youtu\.be\/|\/shorts\/)([A-Za-z0-9_\-]{6,})/);
    return m ? m[1] : null;
  }
  function createOrLoadYt(id){
    ytWrap.style.display = 'block';
    if(!ytPlayer){
      ytPlayer = new YT.Player('ytPlayer', {
        videoId:id,
        playerVars:{playsinline:1,modestbranding:1,rel:0},
        events:{onReady:()=>{ try{ ytPlayer.playVideo(); }catch{}; }, onStateChange:()=>{}}
      });
    }else{
      ytPlayer.loadVideoById(id);
    }
  }

  // =========== HLS ===========
  function playHls(url){
    video.style.display='block'; ytWrap.style.display='none'; embedFrame.style.display='none';
    if(window.Hls && window.Hls.isSupported()){
      currentHls = new Hls();
      currentHls.attachMedia(video);
      currentHls.on(Hls.Events.MEDIA_ATTACHED, ()=> currentHls.loadSource(url));
      currentHls.on(Hls.Events.MANIFEST_PARSED, (evt,data)=>{
        const levels = data?.levels || currentHls.levels || [];
        buildHlsLevels(levels, url);
        video.play().catch(()=>{});
      });
      currentHls.on(Hls.Events.ERROR, (evt, data)=>{
        if(data?.fatal){
          if(data.type===Hls.ErrorTypes.NETWORK_ERROR){ showError('Ø®Ø·Ø£ Ø´Ø¨ÙƒØ© Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ m3u8.'); currentHls.startLoad(); }
          else if(data.type===Hls.ErrorTypes.MEDIA_ERROR){ showError('Ø®Ø·Ø£ ÙˆØ³Ø§Ø¦Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„.'); currentHls.recoverMediaError(); }
          else { showError('Ø®Ø·Ø£ Ù‚Ø§ØªÙ„ ÙÙŠ HLS.'); currentHls.destroy(); }
        }
      });
    }else if(video.canPlayType('application/vnd.apple.mpegURL')){
      video.src = url;
      buildHlsLevels([], url);
      video.addEventListener('loadedmetadata', ()=> video.play().catch(()=>{}), {once:true});
    }else{
      showError('Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… HLS ÙˆÙ„Ø§ hls.js.');
    }
    prepareDownloadUI(url);
  }
  function buildHlsLevels(levels, masterUrl){
    hlsList.innerHTML=''; hlsBox.classList.remove('hidden');
    // ØµÙ Ø§Ù„Ù…Ø§Ø³ØªØ±
    hlsList.appendChild(makeRow('Ù…Ù„Ù m3u8 (Ø§Ù„Ù…Ø§Ø³ØªØ±)', masterUrl, [
      makeBtn('ÙØªØ­', masterUrl, true),
      makeCopyBtn('Ù†Ø³Ø® Ø§Ù„Ù…Ø§Ø³ØªØ±', masterUrl)
    ], masterUrl));
    // Ù…Ø³ØªÙˆÙŠØ§Øª
    if(levels?.length){
      levels.forEach((lvl, i)=>{
        const h = lvl.height || (lvl.attrs && (lvl.attrs.RESOLUTION||'').split('x')[1]) || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        const br = lvl.bitrate ? Math.round(lvl.bitrate/1000)+'kbps' : 'â€”';
        const row = document.createElement('div'); row.className='dl-item';
        const left = document.createElement('div'); left.className='dl-left';
        const b = document.createElement('span'); b.className='badge'; b.textContent = `Ø¬ÙˆØ¯Ø© ${h}`;
        const m = document.createElement('span'); m.className='meta'; m.textContent = `Ù…Ø¹Ø¯Ù„: ${br}`;
        left.appendChild(b); left.appendChild(m);
        const btns = document.createElement('div'); btns.className='row-btns';
        const choose = document.createElement('button'); choose.className='dl-btn'; choose.textContent='ØªØ´ØºÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆØ¯Ø©';
        choose.onclick = ()=>{ if(currentHls){ currentHls.currentLevel=i; showInfo(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¬ÙˆØ¯Ø© ${h}`); video.play().catch(()=>{}); } };
        btns.appendChild(choose);
        row.appendChild(left); row.appendChild(btns);
        hlsList.appendChild(row);
      });
    }else{
      const note = document.createElement('div'); note.className='msg'; note.textContent='Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø¬ÙˆØ¯Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ø¹ Ø¯Ø¹Ù… HLS Ø§Ù„Ø£ØµÙ„ÙŠ.';
      hlsList.appendChild(note);
    }
  }

  // =========== DASH ===========
  function playDash(url){
    video.style.display='block'; ytWrap.style.display='none'; embedFrame.style.display='none';
    dashPlayer = dashjs.MediaPlayer().create();
    dashPlayer.initialize(video, url, true);
    dashPlayer.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, ()=>{
      updateDashQualities();
    });
    dashPlayer.on(dashjs.MediaPlayer.events.QUALITY_CHANGE_RENDERED, ()=>{
      showInfo('ØªÙ… ØªØ¨Ø¯ÙŠÙ„ Ø¬ÙˆØ¯Ø© DASH.');
    });
    prepareDownloadUI(url); // ØªÙ†Ø²ÙŠÙ„ Ø³ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ¯Ø± ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙ‡
    dashBox.classList.remove('hidden');
  }
  function updateDashQualities(){
    if(!dashPlayer) return;
    const list = dashPlayer.getBitrateInfoListFor('video') || [];
    dashQuality.innerHTML = '<option value="auto">ØªÙ„Ù‚Ø§Ø¦ÙŠ</option>';
    list.forEach((q, idx)=>{
      const h = q.height || 'â€”';
      const br = q.bitrate ? Math.round(q.bitrate/1000)+'kbps' : '';
      const opt = document.createElement('option');
      opt.value = String(idx);
      opt.textContent = `${h} ${br}`;
      dashQuality.appendChild(opt);
    });
  }
  dashApply.onclick = ()=>{
    if(!dashPlayer) return;
    const val = dashQuality.value;
    if(val==='auto'){
      dashPlayer.updateSettings({ streaming:{ abr:{ autoSwitchBitrate:{ video:true } } } });
      showInfo('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¬ÙˆØ¯Ø© (DASH).');
    }else{
      dashPlayer.updateSettings({ streaming:{ abr:{ autoSwitchBitrate:{ video:false } } } });
      dashPlayer.setQualityFor('video', Number(val));
      showInfo(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø¬ÙˆØ¯Ø© DASH (${dashQuality.options[dashQuality.selectedIndex].textContent}).`);
    }
  };

  // =========== Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ù„Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ===========
  function prepareDownloadUI(url){
    dlList.innerHTML=''; dlBox.classList.remove('hidden');
    dlList.appendChild(makeRow('Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ØµÙ„ÙŠ', url, [
      makeOpenBtn(url),
      makeDownloadBtn(url),
      makeCopyBtn('Ù†Ø³Ø®', url)
    ], url));

    // ØªØ®Ù…ÙŠÙ† Ø§Ù„Ø¬ÙˆØ¯Ø§Øª Ø¨Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙÙ‚Ø·
    if(isFile(url)){
      ['1080p','720p','480p','360p'].forEach(q=>{
        const guessed = url
          .replace(/(\d{3,4}p)/i, q)
          .replace(/_(\d{3,4})\./, `_${q.replace('p','')}.`)
          .replace(/-(\d{3,4})\./, `-${q.replace('p','')}.`);
        if(guessed!==url){
          dlList.appendChild(makeRow(`Ø¬ÙˆØ¯Ø© ${q} (ØªØ®Ù…ÙŠÙ†ÙŠ)`, guessed, [
            makeOpenBtn(guessed),
            makeDownloadBtn(guessed),
            makeCopyBtn('Ù†Ø³Ø®', guessed)
          ], guessed));
        }
      });
    }

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (Ù‚Ø¯ ÙŠÙØ´Ù„ Ø¨Ø³Ø¨Ø¨ CORS)
    fetchHeadSize(url).then(bytes=>{
      if(bytes){ infoBytes.textContent = formatBytes(bytes); }
    });
  }
  function makeOpenBtn(href){ return makeBtn('ÙØªØ­', href, true); }
  function makeDownloadBtn(href){ const a=document.createElement('a'); a.className='dl-btn'; a.href=href; a.download=''; a.textContent='ØªÙ†Ø²ÙŠÙ„'; return a; }
  function makeCopyBtn(label, href){ const b=document.createElement('button'); b.className='dl-btn'; b.textContent=label; b.onclick=async()=>{ try{ await navigator.clipboard.writeText(href); b.textContent='ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“'; setTimeout(()=>b.textContent=label, 1200);}catch{ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø®'); } }; return b; }
  function makeBtn(label, href, isLink){
    if(isLink){ const a=document.createElement('a'); a.className='dl-btn'; a.href=href; a.target='_blank'; a.rel='noopener'; a.textContent=label; return a; }
    const b=document.createElement('button'); b.className='dl-btn'; b.textContent=label; return b;
  }
  function makeRow(label, href, controls, rawHref){
    const row=document.createElement('div'); row.className='dl-item';
    const left=document.createElement('div'); left.className='dl-left';
    const badge=document.createElement('span'); badge.className='badge'; badge.textContent=label;
    const meta=document.createElement('span'); meta.className='meta';
    try{ const u=new URL(href,location.href); meta.textContent = u.hostname + u.pathname; }catch{ meta.textContent = href; }
    left.appendChild(badge); left.appendChild(meta);
    const btns=document.createElement('div'); btns.className='row-btns';
    controls.forEach(c=>btns.appendChild(c));
    row.appendChild(left); row.appendChild(btns);
    return row;
  }

  // =========== Ø§Ù„ØªØ´ØºÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø± ===========
  function playUrl(rawInput){
    let url = cleanUrl(rawInput);
    if(!validateUrl(url)){
      try{ url = new URL(url, location.href).toString(); }catch{ showError('Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­.'); return; }
    }
    if(isHttpsPage && /^http:\/\//i.test(url)){ url = toHttps(url); showInfo('ØªÙ… ØªØ­ÙˆÙŠÙ„ http Ø¥Ù„Ù‰ https Ù„ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„Ø­Ø¸Ø±.'); }

    resetPanels();
    setTopBar('direct', url); // Ù…Ø¤Ù‚ØªÙ‹Ø§Ø› Ø³Ù†Ø¹Ø¯Ù‘Ù„ Ø­Ø³Ø¨ Ø§Ù„ÙƒØ´Ù Ø£Ø¯Ù†Ø§Ù‡

    // YouTube
    if(isYouTube(url)){
      const id = extractYtId(url);
      if(!id){ showError('ØªØ¹Ø°Ù‘Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù YouTube Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·.'); return; }
      setTopBar('youtube', url);
      ytWrap.style.display='block';
      embedFrame.style.display='none'; video.style.display='none';
      if(ytApiReady) createOrLoadYt(id); else pendingYtId=id;
      infoBytes.textContent='â€”';
      saveHistory({url});
      return;
    }

    // Vimeo
    if(isVimeo(url)){
      setTopBar('vimeo', url);
      const vid = (url.match(/vimeo\.com\/(?:video\/)?(\d{6,})/)||[])[1];
      const embed = vid ? `https://player.vimeo.com/video/${vid}?autoplay=1&title=0&byline=0&portrait=0` : url;
      embedFrame.src = embed; embedFrame.style.display='block'; ytWrap.style.display='none'; video.style.display='none';
      infoBytes.textContent='â€”'; saveHistory({url}); return;
    }

    // TikTok
    if(isTikTok(url)){
      setTopBar('tiktok', url);
      const tid = (url.match(/tiktok\.com\/(?:@[^/]+\/)?video\/(\d+)/)||[])[1];
      embedFrame.src = tid ? `https://www.tiktok.com/embed/v2/video/${tid}` : url;
      embedFrame.style.display='block'; ytWrap.style.display='none'; video.style.display='none';
      infoBytes.textContent='â€”'; saveHistory({url}); return;
    }

    // Facebook
    if(isFB(url)){
      setTopBar('facebook', url);
      embedFrame.src = `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(url)}&show_text=false&autoplay=true`;
      embedFrame.style.display='block'; ytWrap.style.display='none'; video.style.display='none';
      infoBytes.textContent='â€”'; saveHistory({url}); return;
    }

    // HLS
    if(isHls(url)){
      setTopBar('hls', url);
      playHls(url);
      video.style.display='block';
      saveHistory({url});
      return;
    }

    // DASH
    if(isDash(url)){
      setTopBar('dash', url);
      playDash(url);
      video.style.display='block';
      saveHistory({url});
      return;
    }

    // Ù…Ù„ÙØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
    if(isFile(url)){
      setTopBar('direct', url);
      video.style.display='block';
      video.src = url;
      video.addEventListener('loadedmetadata', ()=>{ video.play().catch(()=>{}); }, {once:true});
      prepareDownloadUI(url);
      saveHistory({url});
      return;
    }

    showError('Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·. Ø£Ø¯Ø®Ù„ mp4 / webm / m3u8 / mpd Ø£Ùˆ Ø±Ø§Ø¨Ø· YouTube/Vimeo/TikTok/Facebook.');
  }

  // Ø£Ø­Ø¯Ø§Ø«
  playBtn.onclick = ()=> playUrl(input.value);
  input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') playBtn.click(); });

  // Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§: Ø¥Ù† Ø£Ø¯Ø®Ù„Øª Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ø¨Ø§Ù„Ø¥ÙŠÙ…Ø¨Ø¯ Ù…Ø¹ ? ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø³ÙŠØ¹Ù…Ù„:
  // Ù…Ø«Ø§Ù„Ùƒ: https://www.youtube.com/embed/QhIB8QZVLNE?

})();
</script>
</body>
</html>
